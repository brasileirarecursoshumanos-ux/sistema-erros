{% extends "base.html" %}

{% block title %}Relatórios - Sistema de Erros{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <!-- Cabeçalho -->
            <div class="card mb-4">
                <div class="card-body">
                    <h1 class="card-title">
                        <i class="fas fa-chart-bar me-2"></i>
                        Relatórios e Exportação
                    </h1>
                    <p class="card-text text-muted">
                        Gere relatórios personalizados e exporte dados para análise
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de Relatório -->
    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-filter me-2"></i>
                    Filtros do Relatório
                </div>
                <div class="card-body">
                    <form id="form-filtros">
                        <!-- Filial -->
                        <div class="mb-3">
                            <label for="filtro-filial" class="form-label">
                                <i class="fas fa-store me-2"></i>
                                Filial (Opcional)
                            </label>
                            <select class="form-select" id="filtro-filial">
                                <option value="">Todas as Filiais</option>
                                <!-- Carregado via JavaScript -->
                            </select>
                        </div>

                        <!-- Período -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar-alt me-2"></i>
                                Período
                            </label>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <input type="date" class="form-control" id="filtro-data-inicio" 
                                           placeholder="Data Inicial">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <input type="date" class="form-control" id="filtro-data-fim" 
                                           placeholder="Data Final">
                                </div>
                            </div>
                            <div class="form-text">
                                Deixe em branco para não filtrar por data
                            </div>
                        </div>

                        <!-- Tipo de Erro -->
                        <div class="mb-3">
                            <label for="filtro-tipo-erro" class="form-label">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Tipo de Erro (Opcional)
                            </label>
                            <select class="form-select" id="filtro-tipo-erro">
                                <option value="">Todos os Tipos</option>
                                <!-- Carregado via JavaScript -->
                            </select>
                        </div>

                        <!-- Botões -->
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" onclick="gerarRelatorio()">
                                <i class="fas fa-search me-2"></i>
                                Gerar Relatório
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="limparFiltros()">
                                <i class="fas fa-eraser me-2"></i>
                                Limpar Filtros
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Estatísticas Rápidas -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-2"></i>
                    Estatísticas Rápidas
                </div>
                <div class="card-body">
                    <div id="estatisticas-rapidas">
                        <!-- Carregado via JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados e Ações -->
        <div class="col-lg-8">
            <!-- Resultados do Relatório -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-list me-2"></i>
                        Resultados do Relatório
                    </div>
                    <div id="contador-resultados" class="badge bg-primary">0 registros</div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabela-resultados">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Filial</th>
                                    <th>Vendedor</th>
                                    <th>Erro</th>
                                    <th>Penalização</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Carregado via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mensagem de nenhum resultado -->
                    <div id="nenhum-resultado" class="text-center py-5" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum registro encontrado</h5>
                        <p class="text-muted">Use os filtros acima para gerar um relatório</p>
                    </div>
                </div>
            </div>

            <!-- Ações de Exportação -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-file-export me-2"></i>
                    Exportação de Dados
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-csv fa-3x text-success mb-3"></i>
                                    <h5 class="card-title">Exportar CSV</h5>
                                    <p class="card-text">Exporte os resultados atuais para Excel/CSV</p>
                                    <button class="btn btn-success" onclick="exportarCSV()" disabled id="btn-exportar-csv">
                                        <i class="fas fa-download me-2"></i> Exportar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-print fa-3x text-primary mb-3"></i>
                                    <h5 class="card-title">Imprimir</h5>
                                    <p class="card-text">Imprima o relatório atual</p>
                                    <button class="btn btn-primary" onclick="imprimirRelatorio()" disabled id="btn-imprimir">
                                        <i class="fas fa-print me-2"></i> Imprimir
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                                    <h5 class="card-title">Dashboard</h5>
                                    <p class="card-text">Veja gráficos e estatísticas detalhadas</p>
                                    <a href="/dashboard" class="btn btn-warning">
                                        <i class="fas fa-chart-bar me-2"></i> Ver Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let resultadosAtuais = [];
    let nomeArquivoCSV = '';
    
    $(document).ready(function() {
        // Carregar filiais para o filtro
        carregarFiliaisFiltro();
        
        // Carregar tipos de erro para o filtro
        carregarTiposErroFiltro();
        
        // Carregar estatísticas rápidas
        carregarEstatisticas();
    });
    
    function carregarFiliaisFiltro() {
        $.get('/api/filiais', function(filiais) {
            const select = $('#filtro-filial');
            select.empty().append('<option value="">Todas as Filiais</option>');
            
            filiais.forEach(function(filial) {
                select.append(`<option value="${filial.codigo}">${filial.codigo} - ${filial.nome}</option>`);
            });
        });
    }
    
    function carregarTiposErroFiltro() {
        $.get('/api/tipos-erro', function(tipos) {
            const select = $('#filtro-tipo-erro');
            select.empty().append('<option value="">Todos os Tipos</option>');
            
            // Usar Set para evitar duplicatas por sigla
            const siglasUnicas = new Set();
            
            tipos.forEach(function(tipo) {
                if (!siglasUnicas.has(tipo.sigla)) {
                    siglasUnicas.add(tipo.sigla);
                    select.append(`<option value="${tipo.sigla}">${tipo.sigla} - ${tipo.criterio}</option>`);
                }
            });
        });
    }
    
    function carregarEstatisticas() {
        $.get('/api/estatisticas', function(data) {
            const container = $('#estatisticas-rapidas');
            container.empty();
            
            container.append(`
                <div class="mb-3">
                    <h6><i class="fas fa-database me-2"></i> Total de Registros</h6>
                    <div class="display-6">${data.total_registros}</div>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-calendar-day me-2"></i> Registros Hoje</h6>
                    <div class="display-6">${data.registros_hoje}</div>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-store me-2"></i> Filial com Mais Registros</h6>
                    ${data.top_filiais.length > 0 ? `
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${data.top_filiais[0].filial}</strong>
                            <span class="badge bg-primary">${data.top_filiais[0].total}</span>
                        </div>
                    ` : '<p class="text-muted">Nenhum registro</p>'}
                </div>
                
                <div>
                    <h6><i class="fas fa-exclamation-triangle me-2"></i> Erro Mais Comum</h6>
                    ${data.top_erros.length > 0 ? `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${data.top_erros[0].sigla}</span>
                            <span class="badge bg-danger">${data.top_erros[0].total}</span>
                        </div>
                    ` : '<p class="text-muted">Nenhum registro</p>'}
                </div>
            `);
        });
    }
    
    function gerarRelatorio() {
        // Coletar filtros
        const filtros = {
            filial: $('#filtro-filial').val(),
            data_inicio: $('#filtro-data-inicio').val(),
            data_fim: $('#filtro-data-fim').val(),
            sigla: $('#filtro-tipo-erro').val()
        };
        
        // Validar datas
        if (filtros.data_inicio && filtros.data_fim && filtros.data_inicio > filtros.data_fim) {
            showAlert('error', 'Erro!', 'Data inicial não pode ser maior que data final!');
            return;
        }
        
        // Mostrar loading
        const btn = $('button[onclick="gerarRelatorio()"]');
        const originalText = btn.html();
        btn.prop('disabled', true).html(`
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Gerando...
        `);
        
        // Enviar para API
        $.ajax({
            url: '/api/relatorio',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(filtros),
            success: function(response) {
                btn.prop('disabled', false).html(originalText);
                
                if (response.success) {
                    resultadosAtuais = response.data || [];
                    nomeArquivoCSV = response.filename;
                    
                    // Atualizar contador
                    $('#contador-resultados').text(`${response.total_registros} registros`);
                    
                    // Mostrar/ocultar tabela
                    if (resultadosAtuais.length > 0) {
                        $('#nenhum-resultado').hide();
                        $('#tabela-resultados').show();
                        atualizarTabelaResultados();
                        
                        // Habilitar botões de exportação
                        $('#btn-exportar-csv, #btn-imprimir').prop('disabled', false);
                    } else {
                        $('#nenhum-resultado').show();
                        $('#tabela-resultados').hide();
                        $('#btn-exportar-csv, #btn-imprimir').prop('disabled', true);
                    }
                    
                    showAlert('success', 'Sucesso!', response.message);
                } else {
                    showAlert('error', 'Erro!', response.message);
                    $('#nenhum-resultado').show();
                    $('#tabela-resultados').hide();
                }
            },
            error: function() {
                btn.prop('disabled', false).html(originalText);
                showAlert('error', 'Erro!', 'Falha na comunicação com o servidor.');
            }
        });
    }
    
    function atualizarTabelaResultados() {
        const tbody = $('#tabela-resultados tbody');
        tbody.empty();
        
        resultadosAtuais.forEach(function(registro) {
            const dataFormatada = formatDate(registro.data_ocorrencia);
            
            tbody.append(`
                <tr>
                    <td>
                        <span class="badge bg-secondary">${dataFormatada}</span>
                    </td>
                    <td>
                        <strong>${registro.filial}</strong><br>
                        <small class="text-muted">${registro.nome_filial}</small>
                    </td>
                    <td>${registro.vendedor}</td>
                    <td>
                        <span class="badge bg-warning">${registro.sigla}</span>
                        ${registro.tipo_erro}
                    </td>
                    <td>
                        <span class="badge bg-danger">${registro.penalizacao}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalhesRegistro('${registro.id}')" title="Ver Detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `);
        });
    }
    
    function verDetalhesRegistro(id) {
        // Buscar detalhes do registro
        $.get(`/api/registro/${id}`, function(registro) {
            Swal.fire({
                title: 'Detalhes do Registro',
                html: `
                    <div class="text-start">
                        <p><strong>Filial:</strong> ${registro.filial} - ${registro.nome_filial}</p>
                        <p><strong>Vendedor:</strong> ${registro.vendedor}</p>
                        <p><strong>Erro:</strong> <span class="badge bg-warning">${registro.sigla}</span> ${registro.tipo_erro}</p>
                        <p><strong>Penalização:</strong> <span class="badge bg-danger">${registro.penalizacao}</span></p>
                        <p><strong>Data da Ocorrência:</strong> ${formatDate(registro.data_ocorrencia)}</p>
                        <p><strong>Quantidade:</strong> ${registro.quantidade}</p>
                        <p><strong>Registrado por:</strong> ${registro.registrado_por}</p>
                        <p><strong>Data do Registro:</strong> ${formatDate(registro.data_registro)}</p>
                        ${registro.observacoes ? `<p><strong>Observações:</strong> ${registro.observacoes}</p>` : ''}
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'Fechar'
            });
        });
    }
    
    function exportarCSV() {
        if (!nomeArquivoCSV) {
            showAlert('error', 'Erro!', 'Nenhum relatório gerado para exportar!');
            return;
        }
        
        // Criar link de download
        const link = document.createElement('a');
        link.href = `/download/${nomeArquivoCSV}`;
        link.download = nomeArquivoCSV;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('success', 'Sucesso!', 'Download iniciado!');
    }
    
    function imprimirRelatorio() {
        if (resultadosAtuais.length === 0) {
            showAlert('error', 'Erro!', 'Nenhum relatório para imprimir!');
            return;
        }
        
        // Criar conteúdo para impressão
        let conteudo = `
            <html>
            <head>
                <title>Relatório de Erros - ${new Date().toLocaleDateString('pt-BR')}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th { background-color: #2c3e50; color: white; padding: 10px; text-align: left; }
                    td { padding: 8px; border-bottom: 1px solid #ddd; }
                    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8em; }
                    .footer { margin-top: 30px; font-size: 0.9em; color: #666; }
                </style>
            </head>
            <body>
                <h1>Relatório de Erros</h1>
                <p><strong>Gerado em:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                <p><strong>Total de registros:</strong> ${resultadosAtuais.length}</p>
                
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Filial</th>
                            <th>Vendedor</th>
                            <th>Erro</th>
                            <th>Penalização</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        resultadosAtuais.forEach(function(registro) {
            const dataFormatada = formatDate(registro.data_ocorrencia);
            conteudo += `
                <tr>
                    <td>${dataFormatada}</td>
                    <td>${registro.filial}</td>
                    <td>${registro.vendedor}</td>
                    <td>${registro.sigla}: ${registro.tipo_erro}</td>
                    <td>${registro.penalizacao}</td>
                </tr>
            `;
        });
        
        conteudo += `
                    </tbody>
                </table>
                
                <div class="footer">
                    <p>Sistema de Registro de Erros - Vendedores</p>
                    <p>13 filiais • 43 vendedores • 15 tipos de erro</p>
                </div>
            </body>
            </html>
        `;
        
        // Abrir janela de impressão
        const janela = window.open('', '_blank');
        janela.document.write(conteudo);
        janela.document.close();
        janela.focus();
        
        setTimeout(function() {
            janela.print();
        }, 500);
    }
    
    function limparFiltros() {
        $('#form-filtros')[0].reset();
        resultadosAtuais = [];
        nomeArquivoCSV = '';
        
        $('#contador-resultados').text('0 registros');
        $('#nenhum-resultado').show();
        $('#tabela-resultados').hide();
        $('#tabela-resultados tbody').empty();
        $('#btn-exportar-csv, #btn-imprimir').prop('disabled', true);
        
        showAlert('info', 'Filtros Limpos', 'Todos os filtros foram resetados.');
    }
</script>
{% endblock %}